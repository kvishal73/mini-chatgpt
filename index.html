<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini ChatGPT Clone</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      background: #343541;
      color: #fff;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .app {
      width: 100%;
      max-width: 900px;
      height: 90vh;
      display: flex;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }
    .sidebar {
      width: 260px;
      background: #202123;
      display: flex;
      flex-direction: column;
      padding: 10px;
      border-right: 1px solid #3f4147;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #343541;
    }
    .login-box {
      padding: 10px;
      border-bottom: 1px solid #3f4147;
    }
    .login-box input {
      width: 100%;
      padding: 6px;
      margin-bottom: 6px;
      border-radius: 6px;
      border: 1px solid #565869;
      background: #40414f;
      color: #fff;
    }
    .login-box button {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: none;
      background: #10a37f;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    .section-title {
      font-size: 13px;
      color: #8e8ea0;
      margin: 10px 0 4px;
    }
    .history-list {
      list-style: none;
      max-height: 45vh;
      overflow-y: auto;
      font-size: 13px;
    }
    .history-item {
      padding: 6px;
      border-radius: 6px;
      cursor: pointer;
      color: #e5e5e5;
    }
    .history-item.active {
      background: #343541;
    }
    .history-item:hover {
      background: #2a2b32;
    }
    .new-chat-btn {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #565869;
      background: #343541;
      color: #fff;
      text-align: left;
      font-size: 13px;
      cursor: pointer;
    }
    .settings {
      margin-top: 10px;
      font-size: 13px;
      color: #e5e5e5;
    }
    .settings select {
      margin-top: 4px;
      width: 100%;
      padding: 4px;
      border-radius: 4px;
      border: 1px solid #565869;
      background: #343541;
      color: #fff;
    }
    .user-info {
      margin-top: auto;
      font-size: 13px;
      padding-top: 8px;
      border-top: 1px solid #3f4147;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .user-info button {
      padding: 3px 8px;
      border-radius: 4px;
      border: none;
      background: #f56565;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    .header {
      height: 50px;
      border-bottom: 1px solid #3f4147;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
    }
    .header h1 {
      font-size: 16px;
    }
    .header span {
      font-size: 12px;
      color: #8e8ea0;
    }
    .messages {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
    }
    .message-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .msg-user {
      background: #343541;
    }
    .msg-bot {
      background: #444654;
    }
    .msg-user, .msg-bot {
      padding: 10px;
      border-radius: 10px;
      display: flex;
      max-width: 100%;
    }
    .avatar {
      font-size: 18px;
      margin-right: 6px;
    }
    .bubble {
      white-space: pre-wrap;
      font-size: 14px;
    }
    .empty-center {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #8e8ea0;
      font-size: 14px;
    }
    .input-area {
      border-top: 1px solid #3f4147;
      padding: 8px;
      display: flex;
      gap: 8px;
    }
    .input-area textarea {
      flex: 1;
      resize: none;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #565869;
      background: #40414f;
      color: #fff;
      height: 50px;
    }
    .input-area button {
      padding: 0 14px;
      border-radius: 6px;
      border: none;
      background: #10a37f;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    .small {
      font-size: 11px;
      color: #8e8ea0;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <div class="login-box">
        <input id="nameInput" type="text" placeholder="Your name" />
        <button id="loginBtn">Login</button>
        <div class="small">Name = simple login</div>
      </div>

      <button class="new-chat-btn" id="newChatBtn">+ New chat</button>

      <div>
        <div class="section-title">History</div>
        <ul class="history-list" id="historyList"></ul>
      </div>

      <div class="settings">
        <div>Language</div>
        <select id="languageSelect">
          <option value="hi">Hindi</option>
          <option value="en">English</option>
        </select>
      </div>

      <div class="user-info">
        <span id="userLabel">ðŸ‘¤ Guest</span>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="main">
      <div class="header">
        <h1>Mini ChatGPT</h1>
        <span>Simple HTML + Node + OpenAI</span>
      </div>

      <div id="emptyCenter" class="empty-center">
        Click "New chat" and type something.
      </div>

      <div id="chatArea" style="display:none; flex:1; flex-direction:column;">
        <div class="messages" id="messagesBox"></div>
        <div class="input-area">
          <textarea id="msgInput" placeholder="Type your message..."></textarea>
          <button id="sendBtn">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== FRONTEND JS ==================== -->
  <script>
    const API_URL = "http://localhost:3000/api/chat";

    let userName = "";
    let language = "hi";
    let currentChatId = null;
    // chats: { [chatId]: { title, messages: [{role, content}] } }
    let chats = {};

    const nameInput    = document.getElementById("nameInput");
    const loginBtn     = document.getElementById("loginBtn");
    const logoutBtn    = document.getElementById("logoutBtn");
    const userLabel    = document.getElementById("userLabel");
    const newChatBtn   = document.getElementById("newChatBtn");
    const historyList  = document.getElementById("historyList");
    const languageSel  = document.getElementById("languageSelect");
    const emptyCenter  = document.getElementById("emptyCenter");
    const chatArea     = document.getElementById("chatArea");
    const messagesBox  = document.getElementById("messagesBox");
    const msgInput     = document.getElementById("msgInput");
    const sendBtn      = document.getElementById("sendBtn");

    function renderHistory() {
      historyList.innerHTML = "";
      const ids = Object.keys(chats);
      ids.forEach((id) => {
        const li = document.createElement("li");
        li.className = "history-item" + (id === currentChatId ? " active" : "");
        li.textContent = chats[id].title || "New chat";
        li.onclick = () => {
          currentChatId = id;
          renderHistory();
          renderMessages();
        };
        historyList.appendChild(li);
      });
    }

    function renderMessages() {
      if (!currentChatId || !chats[currentChatId]) {
        emptyCenter.style.display = "flex";
        chatArea.style.display = "none";
        return;
      }
      emptyCenter.style.display = "none";
      chatArea.style.display = "flex";
      messagesBox.innerHTML = "";
      chats[currentChatId].messages.forEach((m) => {
        const row = document.createElement("div");
        row.className = "message-row";

        const msgDiv = document.createElement("div");
        msgDiv.className = m.role === "user" ? "msg-user" : "msg-bot";

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = m.role === "user" ? "ðŸ§‘" : "ðŸ¤–";

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = m.content;

        msgDiv.appendChild(avatar);
        msgDiv.appendChild(bubble);
        row.appendChild(msgDiv);
        messagesBox.appendChild(row);
      });
      messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    loginBtn.onclick = () => {
      const name = nameInput.value.trim();
      if (!name) {
        alert("Name required");
        return;
      }
      userName = name;
      userLabel.textContent = "ðŸ‘¤ " + userName;
    };

    logoutBtn.onclick = () => {
      userName = "";
      userLabel.textContent = "ðŸ‘¤ Guest";
    };

    languageSel.onchange = () => {
      language = languageSel.value;
    };

    newChatBtn.onclick = () => {
      const id = Date.now().toString();
      chats[id] = { title: "New chat", messages: [] };
      currentChatId = id;
      renderHistory();
      renderMessages();
    };

    async function sendMessage() {
      const text = msgInput.value.trim();
      if (!text) return;
      if (!currentChatId) {
        alert("Please click New chat first");
        return;
      }

      // frontend history update
      const chat = chats[currentChatId];
      if (chat.messages.length === 0) {
        chat.title = text.slice(0, 25);
      }
      chat.messages.push({ role: "user", content: text });
      msgInput.value = "";
      renderHistory();
      renderMessages();

      // show "Thinking..." bubble
      chat.messages.push({ role: "assistant", content: "Thinking..." });
      renderMessages();

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: userName || "guest",
            chatId: currentChatId,
            language,
            history: chat.messages,
          }),
        });
        const data = await res.json();
        // replace last "Thinking..."
        chat.messages[chat.messages.length - 1] = {
          role: "assistant",
          content: data.reply || "No reply",
        };
        renderMessages();
      } catch (e) {
        chat.messages[chat.messages.length - 1] = {
          role: "assistant",
          content: "Error: " + e.message,
        };
        renderMessages();
      }
    }

    sendBtn.onclick = sendMessage;
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>

  <!-- ==================== BACKEND (Node + Express + OpenAI) ==================== -->
  <!--
    NEEche ka code Node.js me alag file me run hoga: server.js
    yahan sirf reference ke liye likha hai.
  -->
</body>
</html>